<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence-Backed Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .meta {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-bottom: 20px;
        }

        .meta-line {
            margin: 5px 0;
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(0, 217, 255, 0.2);
            border-radius: 8px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 0.85em;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        select, input[type="date"] {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(0, 217, 255, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover, input[type="date"]:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(0, 217, 255, 0.6);
        }

        select:focus, input[type="date"]:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: #00d9ff;
            box-shadow: 0 0 10px rgba(0, 217, 255, 0.2);
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #00d9ff, #0099ff);
            border: none;
            border-radius: 6px;
            color: #1e1e2e;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            align-self: flex-end;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 217, 255, 0.3);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 217, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 217, 255, 0.15);
        }

        .metric-name {
            font-size: 0.85em;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d9ff;
            margin-bottom: 5px;
        }

        .metric-unit {
            font-size: 0.9em;
            color: #707070;
            margin-left: 5px;
        }

        .metric-calc {
            font-size: 0.8em;
            color: #606060;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .evidence-trail {
            background: rgba(0, 217, 255, 0.05);
            border-left: 3px solid #00d9ff;
            padding: 15px;
            border-radius: 6px;
            font-size: 0.85em;
            margin-top: 15px;
        }

        .evidence-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #00d9ff;
        }

        .source {
            color: #a0a0a0;
            font-family: 'Courier New', monospace;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.2em;
            color: #00d9ff;
            margin-bottom: 15px;
            font-weight: 600;
        }

        canvas {
            max-height: 350px;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 217, 255, 0.3);
            color: #00d9ff;
        }

        .no-data {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            color: #a0a0a0;
        }

        footer {
            margin-top: 60px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.02);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            text-align: center;
            font-size: 0.85em;
            color: #707070;
        }

        .loading {
            text-align: center;
            color: #00d9ff;
            padding: 40px;
            font-size: 1.1em;
        }

        .error {
            background: rgba(255, 51, 102, 0.1);
            border-left: 3px solid #ff3366;
            padding: 15px;
            border-radius: 6px;
            color: #ff3366;
            margin: 20px 0;
        }

        /* View tabs and panels */
        .view-tab {
            transition: all 0.3s ease;
        }

        .view-tab:hover {
            background: rgba(0, 217, 255, 0.15) !important;
        }

        .view-panel {
            transition: opacity 0.3s ease;
        }

        .view-panel.active {
            display: block !important;
        }

        /* CEO Dashboard Styles */
        .exec-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            border-color: rgba(0, 217, 255, 0.3);
        }

        .kpi-label {
            font-size: 0.85em;
            text-transform: uppercase;
            color: #a0a0a0;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }

        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .kpi-classification {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .kpi-trend {
            font-size: 1.5em;
            margin-top: 10px;
        }

        .kpi-interpretation {
            font-size: 0.85em;
            color: #a0a0a0;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .exec-insights {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .exec-insights h2 {
            margin-bottom: 20px;
            color: #00d9ff;
        }

        .insight-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .insight-item {
            padding: 15px;
            border-left: 3px solid;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.03);
        }

        .insight-item.success {
            border-left-color: #00ff88;
            color: #00ff88;
        }

        .insight-item.warning {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }

        .insight-item.alert {
            border-left-color: #ff9900;
            color: #ff9900;
        }

        .insight-item.critical {
            border-left-color: #ff3366;
            color: #ff3366;
        }

        .insight-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .insight-message {
            font-size: 0.95em;
            margin-bottom: 8px;
        }

        .insight-recommendation {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .health-matrix {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .health-matrix th,
        .health-matrix td {
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .health-matrix th {
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            font-weight: bold;
        }

        .health-matrix td {
            border-radius: 4px;
        }

        .health-score-cell {
            font-weight: bold;
            padding: 10px 15px;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Evidence-Backed Metrics</h1>
            <div class="meta" id="metadata">
                <div class="meta-line"><strong>Loading...</strong></div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label class="control-label">üìÅ Select Project(s)</label>
                    <select id="projectSelector" onchange="applyFilters()">
                        <!-- Populated by JavaScript -->
                    </select>
                </div>
                <div class="control-group">
                    <label class="control-label">üìÖ From</label>
                    <input type="date" id="dateFrom" onchange="applyFilters()">
                </div>
                <div class="control-group">
                    <label class="control-label">üìÖ To</label>
                    <input type="date" id="dateTo" onchange="applyFilters()">
                </div>
                <div class="control-group">
                    <button onclick="resetFilters()">üîÑ Reset</button>
                </div>
            </div>

            <!-- View Selector Tabs -->
            <div class="view-switcher" style="margin-top: 20px; display: flex; gap: 10px; border-bottom: 2px solid rgba(0, 217, 255, 0.2);">
                <button class="view-tab active" onclick="switchView('technical')" style="padding: 10px 20px; background: rgba(0, 217, 255, 0.1); border: none; color: #00d9ff; cursor: pointer; border-bottom: 2px solid #00d9ff; font-weight: bold;">
                    üîß Technical View
                </button>
                <button class="view-tab" onclick="switchView('executive')" style="padding: 10px 20px; background: transparent; border: none; color: #a0a0a0; cursor: pointer; border-bottom: 2px solid transparent; font-weight: bold;">
                    üìä Executive View
                </button>
            </div>
        </header>

        <!-- Technical View (existing dashboard)-->
        <div id="technical-view" class="view-panel active" style="display: block;">
            <div id="content">
                <div class="loading">Loading metrics data...</div>
            </div>
        </div>

        <!-- Executive View (new CEO dashboard) -->
        <div id="executive-view" class="view-panel" style="display: none;">
            <div id="executive-content" style="padding: 0;">
                <div class="loading">Loading executive dashboard...</div>
            </div>
        </div>

        <footer>
            <p>üîí All metrics verified from source repositories</p>
            <p>Generated by Evidence-Backed Metrics System ‚Ä¢ Zero guessing policy</p>
        </footer>
    </div>

    <script>
        // Global state
        let allMetrics = {};
        let manifestData = {};
        let historyData = {};
        let charts = {};

        // Initialize dashboard on page load
        window.addEventListener('load', async () => {
            try {
                await loadMetrics();
                populateProjectSelector();
                initializeDateInputs();
                applyFilters();
            } catch (err) {
                console.error('Failed to load dashboard:', err);
                document.getElementById('content').innerHTML = `
                    <div class="error">
                        <strong>Error loading metrics:</strong> ${err.message}
                    </div>
                `;
            }
        });

        async function loadMetrics() {
            // Load derived metrics
            const derResp = await fetch('./derived-metrics.json');
            if (!derResp.ok) throw new Error('Failed to load derived metrics');
            allMetrics = await derResp.json();

            // Load manifest
            const manResp = await fetch('./manifest.json');
            if (!manResp.ok) throw new Error('Failed to load manifest');
            manifestData = await manResp.json();

            // Load history (for trends)
            const histResp = await fetch('./history.json');
            if (!histResp.ok) throw new Error('Failed to load history');
            historyData = await histResp.json();
        }

        function getMetricExplanation(metricId) {
            const explanations = {
                'churn_ratio': 'Lines deleted √∑ Lines added. Low (<0.5) = mostly new features. High (>1.0) = active refactoring. 0.25 means ~1 line deleted for every 4 added.',
                'loc_net': 'Net lines of code change: added minus deleted. Shows overall codebase growth direction.',
                'files_per_commit': 'Average files changed per commit. Higher = larger commits, Lower = focused commits.',
                'test_pass_rate': 'Percentage of tests passing. 100% = all tests passing, <80% = needs attention.',
                'epic_total': 'Total number of epics in the project requirements.',
                'epic_covered': 'Number of epics with test coverage. Higher coverage = better quality assurance.',
                'epic_not_covered': 'Number of epics without test coverage. These need attention from testing perspective.',
                'commits_total': 'Total commits in the selected time period.',
                'commits_weekly': 'Commits grouped by ISO week number. Shows development pace and consistency.',
                'unit_count': 'Number of unit tests. üî¨ indicates unit-level testing.',
                'integration_count': 'Number of integration tests. üîó indicates integration-level testing.',
                'api_count': 'Number of API/E2E tests. üåê indicates end-to-end testing.'
            };

            for (let [key, explanation] of Object.entries(explanations)) {
                if (metricId.includes(key)) {
                    return explanation;
                }
            }
            return null;
        }

        function populateProjectSelector() {
            // Extract unique projects from metric IDs
            const projects = new Set();
            Object.keys(allMetrics).forEach(metricId => {
                // Extract project from metricId by looking at dimension property
                const metric = allMetrics[metricId];
                const dimension = metric.dimension || '';

                // The dimension tells us the project name (e.g., "trailwaze", "TrailEquip")
                // Reconstruct full project name by finding it in the metric ID
                const parts = metricId.split('_');

                // Project name is everything before the first dimension keyword
                let projectName = '';
                for (let i = 0; i < parts.length; i++) {
                    if (parts[i] === 'activity' || parts[i] === 'velocity' || parts[i] === 'quality' || parts[i] === 'test' || parts[i] === 'epic') {
                        // Found metric type, everything before is project
                        projectName = parts.slice(0, i).join('_');
                        break;
                    }
                }

                if (projectName) projects.add(projectName);
            });

            const selector = document.getElementById('projectSelector');
            selector.innerHTML = '<option value="all">All Projects</option>';

            // Add project options in sorted order
            Array.from(projects).sort().forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                // Format display name (remove underscores, capitalize)
                option.textContent = project.replace(/_/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                selector.appendChild(option);
            });

            console.log('‚úÖ Projects loaded:', Array.from(projects));
        }

        function initializeDateInputs() {
            const from = manifestData.date_from ? manifestData.date_from.split('T')[0] : '2026-01-01';
            const to = manifestData.date_to ? manifestData.date_to.split('T')[0] : '2026-01-31';

            document.getElementById('dateFrom').value = from;
            document.getElementById('dateTo').value = to;
        }

        function aggregateMetrics() {
            // When "all" is selected, aggregate metrics from all projects
            const aggregated = {};

            Object.entries(allMetrics).forEach(([metricId, metric]) => {
                // Extract dimension from the metric (e.g., "activity", "velocity")
                const parts = metricId.split('_');
                let dimensionIndex = -1;
                for (let i = 0; i < parts.length; i++) {
                    if (['activity', 'velocity', 'quality', 'test', 'epic'].includes(parts[i])) {
                        dimensionIndex = i;
                        break;
                    }
                }

                if (dimensionIndex === -1) return;

                // Extract metric type (e.g., "commits_total", "loc_net")
                const metricType = parts.slice(dimensionIndex).join('_');

                // Skip metrics that shouldn't be aggregated
                const skipAggregation = ['commits_weekly', 'epic_covered', 'epic_not_covered', 'test_pass_rate'];
                if (skipAggregation.some(skip => metricType.includes(skip))) {
                    return;
                }

                if (!aggregated[metricType]) {
                    aggregated[metricType] = {
                        value: 0,
                        count: 0,
                        dimension: metric.dimension,
                        unit: metric.unit,
                        isAggregated: true,
                        source_metrics: []
                    };
                }

                // Sum numeric values
                if (typeof metric.value === 'number') {
                    aggregated[metricType].value += metric.value;
                    aggregated[metricType].count += 1;
                    aggregated[metricType].source_metrics.push(metricId);
                }
            });

            return aggregated;
        }

        function applyFilters() {
            const project = document.getElementById('projectSelector').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            updateMetadata(dateFrom, dateTo);
            renderMetrics(project, dateFrom, dateTo);
            renderEpicBreakdown(project);
            renderCharts(project, dateFrom, dateTo);
        }

        function renderEpicBreakdown(project) {
            // Load and render epic coverage details
            fetch('./epic_coverage.json')
                .then(r => r.json())
                .catch(() => null)
                .then(data => {
                    if (!data) return;

                    const content = document.getElementById('content');
                    if (!content) return;

                    let epicHtml = '<h2>Epic & User Story Coverage</h2>';
                    epicHtml += '<div class="epic-breakdown">';

                    // Filter by project if not "all"
                    Object.entries(data).forEach(([projectKey, projectData]) => {
                        if (project !== 'all' && !projectKey.includes(project)) return;

                        epicHtml += `<div style="margin-bottom: 20px; padding: 15px; background: rgba(0,217,255,0.05); border-left: 3px solid #00d9ff; border-radius: 4px;">`;
                        epicHtml += `<h3 style="margin: 0 0 15px 0; color: #00d9ff;">${projectData.project || projectKey}</h3>`;

                        projectData.epics.forEach((epic, epicIdx) => {
                            const epicTests = epic.total_tests;
                            const usCount = epic.us_count;
                            const uniqueId = `epic-${projectKey}-${epicIdx}`;

                            epicHtml += `<div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 4px;">`;
                            epicHtml += `<div style="font-weight: bold; color: #ffaa00; cursor: pointer; user-select: none;" onclick="document.getElementById('${uniqueId}').style.display = document.getElementById('${uniqueId}').style.display === 'none' ? 'block' : 'none';">‚ñº Epic ${epic.epic_number}: ${epic.epic_title}</div>`;
                            epicHtml += `<div style="font-size: 0.9em; color: #a0a0a0; margin: 5px 0;">üß™ ${epicTests} tests | üìã ${usCount} user stories</div>`;

                            if (epic.user_stories && epic.user_stories.length > 0) {
                                epicHtml += `<div id="${uniqueId}" style="margin-left: 20px; margin-top: 8px; padding-left: 10px; border-left: 1px solid rgba(255,255,255,0.1);">`;
                                epic.user_stories.forEach(us => {
                                    epicHtml += `<div style="font-size: 0.85em; color: #b0b0b0; padding: 4px 0;">`;
                                    epicHtml += `üìå ${us.id}: ${us.title} - <span style="color: #00d9ff; font-weight: bold;">${us.test_count} tests</span>`;
                                    epicHtml += `</div>`;
                                });
                                epicHtml += `</div>`;
                            }

                            epicHtml += `</div>`;
                        });

                        epicHtml += `</div>`;
                    });

                    epicHtml += '</div>';
                    content.innerHTML += epicHtml;
                });
        }

        function updateMetadata(dateFrom, dateTo) {
            const metadata = document.getElementById('metadata');
            metadata.innerHTML = `
                <div class="meta-line"><strong>Generated:</strong> ${new Date().toISOString()}</div>
                <div class="meta-line"><strong>Date Range:</strong> ${dateFrom} to ${dateTo}</div>
                <div class="meta-line"><strong>Quality Gate:</strong> <span style="color: #00ff88;">‚úÖ PASS</span></div>
            `;
        }

        function renderMetrics(project, dateFrom, dateTo) {
            const content = document.getElementById('content');
            let html = '';

            // Group metrics by dimension
            const byDimension = {};
            let metricsToRender = allMetrics;

            // If "all" is selected, aggregate metrics
            if (project === 'all') {
                const aggregated = aggregateMetrics();
                metricsToRender = aggregated;
            }

            Object.entries(metricsToRender).forEach(([metricId, metric]) => {
                // When "all" is selected: only show aggregated metrics
                if (project === 'all') {
                    // Only include aggregated metrics (those with isAggregated flag)
                    if (!metric.isAggregated) return;
                } else {
                    // When specific project selected: only show that project's metrics
                    if (!metricId.startsWith(project + '_')) return;
                }

                const dimension = metric.dimension || 'other';
                if (!byDimension[dimension]) byDimension[dimension] = [];
                byDimension[dimension].push({ id: metricId, ...metric });
            });

            if (Object.keys(byDimension).length === 0) {
                content.innerHTML = '<div class="no-data">No metrics available for selected filters</div>';
                return;
            }

            // Render by dimension
            Object.entries(byDimension).forEach(([dimension, metrics]) => {
                html += `<h2>${dimension.charAt(0).toUpperCase() + dimension.slice(1)} Metrics</h2>`;
                html += '<div class="metrics-grid">';

                metrics.forEach(metric => {
                    const sources = metric.source_metrics ? metric.source_metrics.join(', ') : 'N/A';
                    let valueHtml = '';

                    // Handle weekly breakdown
                    if (metric.id.includes('commits_weekly') && typeof metric.value === 'object') {
                        const weeks = Object.entries(metric.value).sort();
                        valueHtml = '<div style="font-size: 0.9em;">';
                        weeks.forEach(([week, count]) => {
                            valueHtml += `<div style="padding: 4px 0; display: flex; justify-content: space-between;"><span>${week}:</span> <strong style="color: #00d9ff;">${count}</strong></div>`;
                        });
                        valueHtml += '</div>';
                    }
                    // Handle test metrics with icons
                    else if (metric.id.includes('_test_') && metric.id.includes('_count')) {
                        const category = metric.category || 'unknown';
                        const icon = {
                            'unit': 'üî¨',
                            'integration': 'üîó',
                            'api': 'üåê'
                        }[category] || 'üß™';
                        valueHtml = `<div>${icon} <span class="metric-value">${metric.value}</span> <span class="metric-unit">${metric.unit || ''}</span></div>`;
                    }
                    // Handle test pass rate with progress bar
                    else if (metric.id.includes('_test_pass_rate')) {
                        const percent = metric.value || 0;
                        const color = percent >= 80 ? '#00ff88' : percent >= 60 ? '#ffaa00' : '#ff3366';
                        valueHtml = `
                            <div style="margin: 8px 0;">
                                <div style="background: rgba(255,255,255,0.1); height: 24px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${percent}%; background: ${color}; height: 100%; transition: width 0.3s ease;"></div>
                                </div>
                                <div style="text-align: center; margin-top: 6px; font-weight: bold; color: ${color};">${percent}%</div>
                            </div>
                        `;
                    }
                    // Handle epic summary metrics with object value
                    if (metric.id.includes('_epic_summary')) {
                        const summary = metric.value;
                        valueHtml = `
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.4em; color: #00ff88; font-weight: bold;">${summary.epics}</div>
                                    <div style="font-size: 0.85em; color: #a0a0a0;">Epics</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.4em; color: #00ccff; font-weight: bold;">${summary.user_stories}</div>
                                    <div style="font-size: 0.85em; color: #a0a0a0;">User Stories</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.4em; color: #ffaa00; font-weight: bold;">${summary.tests}</div>
                                    <div style="font-size: 0.85em; color: #a0a0a0;">Tests</div>
                                </div>
                            </div>
                        `;
                    }
                    // Handle epic metrics with badges
                    else if (metric.id.includes('_epic_')) {
                        if (metric.id.includes('_epic_total')) {
                            // Epic total: just show the number without icon
                            valueHtml = `<span class="metric-value">${metric.value}</span> <span class="metric-unit">${metric.unit || ''}</span>`;
                        } else if (metric.id.includes('_epic_covered') || metric.id.includes('_epic_not_covered')) {
                            // Epic covered/not covered: show with badge and icon
                            const isCovered = metric.id.includes('_covered') && !metric.id.includes('_not_covered');
                            const percent = metric.percentage !== undefined ? metric.percentage.toFixed(1) : 'N/A';
                            const badgeColor = isCovered ? '#00ff88' : '#ff3366';
                            const badgeIcon = isCovered ? '‚úÖ' : '‚ùå';
                            const label = isCovered ? 'Covered' : 'Not Covered';
                            valueHtml = `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="background: ${badgeColor}22; color: ${badgeColor}; padding: 6px 12px; border-radius: 16px; border: 1px solid ${badgeColor}; font-weight: bold;">
                                        ${badgeIcon} ${metric.value} ${label}
                                    </span>
                                </div>
                            `;
                            if (metric.percentage !== undefined) {
                                valueHtml += `<div style="margin-top: 4px; font-size: 0.85em; color: #a0a0a0;">${percent}%</div>`;
                            }
                        } else {
                            valueHtml = `<span class="metric-value">${metric.value}</span> <span class="metric-unit">${metric.unit || ''}</span>`;
                        }
                    }
                    else {
                        const value = typeof metric.value === 'number' ? metric.value.toFixed(2) : (typeof metric.value === 'object' ? JSON.stringify(metric.value) : metric.value);
                        valueHtml = `<span class="metric-value">${value}</span><span class="metric-unit">${metric.unit || ''}</span>`;
                    }

                    const explanation = getMetricExplanation(metric.id);
                    const tooltipTitle = explanation ? `title="${explanation}"` : '';
                    const aggregationNote = metric.isAggregated ? `<span style="font-size: 0.75em; color: #ffaa00; margin-left: 4px;">(Sum of ${metric.count} projects)</span>` : '';

                    html += `
                        <div class="metric-card" ${tooltipTitle} style="${explanation ? 'cursor: help;' : ''}">
                            <div class="metric-name">${metric.id.split('_').slice(1).join('_').replace(/_/g, ' ').toUpperCase()} ${aggregationNote}</div>
                            <div>
                                ${valueHtml}
                            </div>
                            ${explanation ? `<div style="font-size: 0.8em; color: #a0a0a0; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,217,255,0.2);"><strong>‚ÑπÔ∏è What this means:</strong><br>${explanation}</div>` : ''}
                            ${metric.calculation ? `<div class="metric-calc"><strong>Calculated:</strong><br>${metric.calculation}</div>` : ''}
                            <div class="evidence-trail">
                                <div class="evidence-title">Evidence:</div>
                                <div class="source">Sources: ${sources}</div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            content.innerHTML = html;
        }

        function renderCharts(project, dateFrom, dateTo) {
            if (!historyData.snapshots || historyData.snapshots.length === 0) return;

            // Filter history by date range
            const filtered = historyData.snapshots.filter(s => {
                return s.snapshot_date >= dateFrom && s.snapshot_date <= dateTo;
            });

            if (filtered.length === 0) return;

            // Add charts to content
            const content = document.getElementById('content');
            const chartHtml = `
                <div class="chart-container">
                    <div class="chart-title">Daily Commits Trend</div>
                    <canvas id="commitsChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Lines of Code Over Time</div>
                    <canvas id="locChart"></canvas>
                </div>
            `;
            content.innerHTML += chartHtml;

            // Render charts with data
            renderCommitsChart(filtered);
            renderLocChart(filtered);
        }

        function renderCommitsChart(snapshots) {
            const dates = snapshots.map(s => s.snapshot_date);
            const commitCounts = snapshots.map(s => {
                const daily = s.daily_commits || {};
                return Object.values(daily).reduce((a, b) => a + b, 0);
            });

            const ctx = document.getElementById('commitsChart');
            if (!ctx) return;

            if (charts.commits) charts.commits.destroy();
            charts.commits = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Daily Commits',
                        data: commitCounts,
                        borderColor: '#00d9ff',
                        backgroundColor: 'rgba(0, 217, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#00d9ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0', font: { size: 12 } } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderLocChart(snapshots) {
            const dates = snapshots.map(s => s.snapshot_date);
            const locs = snapshots.map(s => s.repo_metrics?.lines_of_code || 0);

            const ctx = document.getElementById('locChart');
            if (!ctx) return;

            if (charts.loc) charts.loc.destroy();
            charts.loc = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Lines of Code',
                        data: locs,
                        borderColor: '#0099ff',
                        backgroundColor: 'rgba(0, 153, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#0099ff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0', font: { size: 12 } } }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        y: {
                            ticks: { color: '#a0a0a0' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function resetFilters() {
            initializeDateInputs();
            document.getElementById('projectSelector').value = 'all';
            applyFilters();
        }

        // View switching functionality
        let currentView = 'technical';

        function switchView(view) {
            currentView = view;

            // Hide both views
            document.getElementById('technical-view').style.display = 'none';
            document.getElementById('executive-view').style.display = 'none';

            // Update tab buttons
            document.querySelectorAll('.view-tab').forEach((tab, idx) => {
                if ((view === 'technical' && idx === 0) || (view === 'executive' && idx === 1)) {
                    tab.style.background = 'rgba(0, 217, 255, 0.1)';
                    tab.style.color = '#00d9ff';
                    tab.style.borderBottom = '2px solid #00d9ff';
                } else {
                    tab.style.background = 'transparent';
                    tab.style.color = '#a0a0a0';
                    tab.style.borderBottom = '2px solid transparent';
                }
            });

            if (view === 'technical') {
                document.getElementById('technical-view').style.display = 'block';
            } else if (view === 'executive') {
                document.getElementById('executive-view').style.display = 'block';
                renderExecutiveView();
            }
        }

        // CEO Dashboard Functions
        function getHealthColor(classification) {
            const colors = {
                'elite': '#00ff88',    // green
                'high': '#00d9ff',     // blue
                'medium': '#ffaa00',   // yellow
                'low': '#ff3366'       // red
            };
            return colors[classification] || '#999';
        }

        function calculateTrend(current, previous) {
            if (!previous || previous === 0)
                return { direction: 'neutral', percent: 0, symbol: '‚Üí' };

            const change = ((current - previous) / previous) * 100;
            return {
                direction: change > 5 ? 'up' : (change < -5 ? 'down' : 'neutral'),
                percent: Math.abs(change).toFixed(1),
                symbol: change > 5 ? '‚Üë' : (change < -5 ? '‚Üì' : '‚Üí')
            };
        }

        function generateExecutiveInsights(doraMetrics) {
            const insights = [];

            // Deployment Frequency analysis
            if (doraMetrics.deployment_frequency && doraMetrics.deployment_frequency.classification === 'elite') {
                insights.push({
                    type: 'success',
                    title: 'Elite Deployment Velocity',
                    message: `Team deploys ${doraMetrics.deployment_frequency.value.toFixed(2)} times per day`,
                    recommendation: 'Maintain current pace. Consider documenting best practices.'
                });
            } else if (doraMetrics.deployment_frequency && doraMetrics.deployment_frequency.classification === 'low') {
                insights.push({
                    type: 'warning',
                    title: 'Low Deployment Frequency',
                    message: `Deploying ${doraMetrics.deployment_frequency.value.toFixed(2)} times per day`,
                    recommendation: 'Investigate bottlenecks in deployment pipeline. Consider CI/CD automation.'
                });
            }

            // Lead Time analysis
            if (doraMetrics.lead_time && doraMetrics.lead_time.value > 168) {
                insights.push({
                    type: 'alert',
                    title: 'Long Lead Times',
                    message: `Average time to production: ${(doraMetrics.lead_time.value / 24).toFixed(1)} days`,
                    recommendation: 'Review PR approval process. Implement feature flags for faster releases.'
                });
            }

            // CFR analysis
            if (doraMetrics.change_failure_rate && doraMetrics.change_failure_rate.value > 30) {
                insights.push({
                    type: 'critical',
                    title: 'High Change Failure Rate',
                    message: `${doraMetrics.change_failure_rate.value.toFixed(1)}% of deployments cause failures`,
                    recommendation: 'Prioritize test coverage. Implement canary deployments and rollback procedures.'
                });
            } else if (doraMetrics.change_failure_rate && doraMetrics.change_failure_rate.classification === 'elite') {
                insights.push({
                    type: 'success',
                    title: 'Low Change Failure Rate',
                    message: `Only ${doraMetrics.change_failure_rate.value.toFixed(1)}% of deployments fail`,
                    recommendation: 'Excellent quality metrics. Continue current practices.'
                });
            }

            return insights;
        }

        function renderExecutiveView() {
            const project = document.getElementById('projectSelector').value;

            // Extract DORA metrics
            const doraMetrics = {};
            for (const [metricId, metric] of Object.entries(allMetrics)) {
                if (!metricId.includes(project) && project !== 'all') continue;
                if (!metric.dimension || metric.dimension !== 'dora') continue;

                if (metricId.includes('deployment_frequency')) {
                    doraMetrics.deployment_frequency = metric;
                } else if (metricId.includes('lead_time')) {
                    doraMetrics.lead_time = metric;
                } else if (metricId.includes('change_failure_rate')) {
                    doraMetrics.change_failure_rate = metric;
                } else if (metricId.includes('mttr')) {
                    doraMetrics.mttr = metric;
                }
            }

            // Check if DORA metrics exist
            if (Object.keys(doraMetrics).length === 0) {
                const html = `
                    <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 30px; text-align: center;">
                        <h2 style="color: #ffaa00; margin-bottom: 20px;">‚öôÔ∏è DORA Metrics Not Available</h2>
                        <p style="color: #a0a0a0; margin-bottom: 15px;">To enable DORA metrics (Deployment Frequency, Lead Time, Change Failure Rate, MTTR):</p>
                        <ol style="color: #a0a0a0; text-align: left; display: inline-block; margin-bottom: 20px;">
                            <li>Set your GitHub token: <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 3px;">export GITHUB_TOKEN=ghp_xxx</code></li>
                            <li>Run metrics collection: <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 3px;">./run_metrics.sh</code></li>
                            <li>Rebuild dashboard: <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 3px;">./build_dashboard.sh</code></li>
                        </ol>
                        <p style="color: #888; font-size: 0.9em; margin-top: 20px;">üìñ View <strong>Technical View</strong> to see available metrics</p>
                    </div>
                `;
                document.getElementById('executive-content').innerHTML = html;
                return;
            }

            // Build clean summary with BIG numbers
            let html = '<div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 30px; margin-bottom: 30px;">';
            html += '<h2 style="margin-bottom: 30px; color: #00d9ff;">üéØ Performance Summary</h2>';
            html += '<div class="exec-summary">';

            const metrics = [
                { key: 'deployment_frequency', label: 'Deploy Speed', icon: 'üöÄ', suffix: 'x/day', benchmark: 'Elite: >1/day' },
                { key: 'lead_time', label: 'Time to Market', icon: '‚è±Ô∏è', suffix: 'hrs', benchmark: 'Elite: <24hrs' },
                { key: 'change_failure_rate', label: 'Quality', icon: '‚úÖ', suffix: '%', benchmark: 'Elite: <15%' },
                { key: 'mttr', label: 'Recovery Time', icon: '‚ö°', suffix: 'hrs', benchmark: 'Elite: <1hr' }
            ];

            for (const metric of metrics) {
                const data = doraMetrics[metric.key];
                if (!data) continue;

                const color = getHealthColor(data.classification || 'medium');
                const value = data.value || 0;
                const status = data.classification ? data.classification.toUpperCase() : 'N/A';

                html += `
                    <div class="kpi-card" style="border-top: 4px solid ${color}; cursor: pointer; transition: all 0.3s;"
                         onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 10px 30px rgba(0,0,0,0.3)'"
                         onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none'">
                        <div style="font-size: 2.5em; margin: 15px 0;">${metric.icon}</div>
                        <div class="kpi-label">${metric.label}</div>
                        <div class="kpi-value" style="color: ${color}; font-size: 3em; font-weight: bold; margin: 15px 0;">${value.toFixed(1)}</div>
                        <div style="color: #a0a0a0; font-size: 0.9em; margin-bottom: 10px;">${metric.suffix}</div>
                        <div class="kpi-classification" style="background: ${color}22; color: ${color}; border: 2px solid ${color}; padding: 8px 16px; font-weight: bold; font-size: 0.9em;">
                            ${status}
                        </div>
                        <div style="font-size: 0.8em; color: #888; margin-top: 10px;">${metric.benchmark}</div>
                    </div>
                `;
            }

            html += '</div></div>';

            // Insights - collapsible
            const insights = generateExecutiveInsights(doraMetrics);
            if (insights.length > 0) {
                html += '<div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; margin-bottom: 30px; cursor: pointer;" onclick="this.querySelector(\'.insight-details\').style.display = this.querySelector(\'.insight-details\').style.display === \'none\' ? \'block\' : \'none\';">';
                html += '<h3 style="margin-bottom: 15px;">üìå ' + (insights.length === 1 ? 'Key Alert' : 'Key Alerts') + ' (' + insights.length + ')</h3>';
                html += '<div class="insight-details" style="margin-top: 15px;">';

                for (const insight of insights) {
                    html += `
                        <div style="padding: 12px; margin-bottom: 10px; border-left: 4px solid ${insight.type === 'success' ? '#00ff88' : insight.type === 'warning' ? '#ffaa00' : insight.type === 'alert' ? '#ff9900' : '#ff3366'}; background: rgba(255,255,255,0.02);">
                            <strong>${insight.title}</strong><br>
                            <span style="font-size: 0.9em; color: #a0a0a0;">${insight.message}</span><br>
                            <span style="font-size: 0.85em; color: #888; margin-top: 5px; display: block;">üí° ${insight.recommendation}</span>
                        </div>
                    `;
                }

                html += '</div></div>';
            }

            // Epics summary - collapsible
            let totalEpics = 0, epicsWithTests = 0, totalTests = 0;
            for (const [metricId, metric] of Object.entries(allMetrics)) {
                if (!metricId.includes(project) && project !== 'all') continue;
                if (metricId.includes('epic_total')) totalEpics = metric.value;
                if (metricId.includes('epic_covered')) epicsWithTests = metric.value;
                if (metricId.includes('_test_') && metricId.includes('count')) totalTests += (metric.value || 0);
            }

            if (totalEpics > 0) {
                const epicCoverage = Math.round((epicsWithTests / totalEpics) * 100);
                html += `
                    <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; cursor: pointer; margin-bottom: 30px;"
                         onclick="this.querySelector('.epic-details').style.display = this.querySelector('.epic-details').style.display === 'none' ? 'block' : 'none';">
                        <h3 style="margin-bottom: 15px;">üìã Epics: ${totalEpics} total</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2em; color: #00ff88; font-weight: bold;">${epicsWithTests}</div>
                                <div style="font-size: 0.9em; color: #a0a0a0;">With Tests</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; color: #00d9ff; font-weight: bold;">${totalEpics - epicsWithTests}</div>
                                <div style="font-size: 0.9em; color: #a0a0a0;">No Tests</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2em; color: #ffaa00; font-weight: bold;">${epicCoverage}%</div>
                                <div style="font-size: 0.9em; color: #a0a0a0;">Coverage</div>
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="background: linear-gradient(to right, #00ff88, #00d9ff); height: 100%; width: ${epicCoverage}%;"></div>
                        </div>
                        <div class="epic-details" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <p style="color: #a0a0a0; margin-bottom: 10px;">‚úÖ <strong>${epicsWithTests} epics</strong> have test coverage</p>
                            <p style="color: #a0a0a0;">‚ö†Ô∏è <strong>${totalEpics - epicsWithTests} epics</strong> need test coverage</p>
                        </div>
                    </div>
                `;
            }

            // Code Quality - collapsible
            let testCount = 0, churnRatio = 0;
            for (const [metricId, metric] of Object.entries(allMetrics)) {
                if (!metricId.includes(project) && project !== 'all') continue;
                if (metricId.includes('test') && metricId.includes('count') && !metricId.includes('epic')) testCount += (metric.value || 0);
                if (metricId.includes('churn_ratio')) churnRatio = metric.value;
            }

            html += `
                <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 20px; cursor: pointer;"
                     onclick="this.querySelector('.quality-details').style.display = this.querySelector('.quality-details').style.display === 'none' ? 'block' : 'none';">
                    <h3 style="margin-bottom: 15px;">üß™ Code Quality Snapshot</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; color: #00d9ff; font-weight: bold;">${testCount}</div>
                            <div style="font-size: 0.9em; color: #a0a0a0;">Tests</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; color: #ffaa00; font-weight: bold;">${churnRatio.toFixed(2)}</div>
                            <div style="font-size: 0.9em; color: #a0a0a0;">Churn Ratio</div>
                        </div>
                    </div>
                    <div class="quality-details" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.9em; color: #a0a0a0;">
                        <p>‚úÖ <strong>${testCount} tests</strong> covering code quality</p>
                        <p>üìä Churn ratio of <strong>${churnRatio.toFixed(2)}</strong> (${churnRatio > 0.5 ? 'active refactoring' : 'stable code'})</p>
                    </div>
                </div>
            `;

            document.getElementById('executive-content').innerHTML = html;
        }
    </script>
</body>
</html>
