name: DORA Metrics Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:

  # ====================================================================
  # STAGE 1: DATA COLLECTION
  # ====================================================================

  collect-data:
    name: "Stage 1: Collect Data & Calculate Metrics"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip

    - name: Create required directories
      run: |
        mkdir -p git_artifacts
        mkdir -p ci_artifacts
        mkdir -p calculations/per_repo
        mkdir -p calculations/global

    - name: "ðŸ“Š Step 1: Parse Repository Configuration"
      run: |
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - Parsing ReposInput.md"
        echo "======================================================================"
        python3 src/collection/collect_git.py --print-repos

    - name: "ðŸ“¥ Step 2: Collect Git Artifacts"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - Git Data Extraction"
        echo "======================================================================"
        python3 src/collection/collect_git.py

    - name: "ðŸ”§ Step 3: Collect CI Artifacts"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - CI Artifacts Extraction"
        echo "======================================================================"
        python3 src/collection/collect_ci.py

    - name: "ðŸ”Ž Step 4: Scan GitHub for Epics & Tests"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - GitHub Artifact Scanning"
        echo "======================================================================"
        python3 src/collection/scan_github_artifacts.py

    - name: "ðŸ§® Step 5: Calculate Metrics"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA CALCULATION LAYER - Metrics Computation"
        echo "======================================================================"
        python3 src/calculations/calculate.py

    - name: "ðŸ“ˆ Step 6: Calculate Test Metrics"
      run: |
        python3 src/calculations/calculate_test_metrics.py

    - name: "âœ… Step 7: Validate Data Quality"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA VALIDATION LAYER - Quality Gates"
        echo "======================================================================"
        python3 src/validation/validate.py

    - name: "ðŸ“‹ Step 8: Generate Validation Manifest"
      run: |
        echo ""
        echo "Generating MANIFEST.json with test metrics..."
        python3 << 'EOF'
import json
from pathlib import Path
from datetime import datetime

# Load existing manifest or create new one
manifest_file = Path("calculations/MANIFEST.json")
if manifest_file.exists():
    with open(manifest_file, 'r') as f:
        manifest = json.load(f)
else:
    manifest = {}

# Load scan results
scan_file = Path("git_artifacts/github_scan_artifacts.json")
if scan_file.exists():
    with open(scan_file, 'r') as f:
        scan_data = json.load(f)

    # Add test metrics
    manifest["testing_metrics"] = {
        "global": {
            "total_test_files": sum(v['count'] for v in scan_data['tests'].values()),
            "total_epics_found": sum(len(v) for v in scan_data['epics'].values()),
            "total_user_stories_found": sum(len(v) for v in scan_data['user_stories'].values())
        },
        "per_repo": {}
    }

    for repo_name in scan_data['tests'].keys():
        manifest["testing_metrics"]["per_repo"][repo_name] = {
            "test_files": scan_data['tests'][repo_name]['count'],
            "test_frameworks": scan_data['test_frameworks'].get(repo_name, []),
            "epics": len(scan_data['epics'].get(repo_name, [])),
            "user_stories": len(scan_data['user_stories'].get(repo_name, [])),
            "sample_test_files": scan_data['tests'][repo_name]['files'][:2]
        }

manifest["generated_at"] = datetime.now(datetime.UTC).isoformat().replace('+00:00', 'Z')

with open(manifest_file, 'w') as f:
    json.dump(manifest, f, indent=2)

print(f"âœ“ Manifest updated: {manifest['testing_metrics']['global']['total_test_files']} tests, "
      f"{manifest['testing_metrics']['global']['total_epics_found']} epics found")
EOF

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: dora-calculations
        path: |
          calculations/
          git_artifacts/
          ci_artifacts/
        retention-days: 30

    - name: "âœ“ Stage 1 Complete"
      run: |
        echo "======================================================================"
        echo "âœ“ DATA COLLECTION STAGE COMPLETE"
        echo "======================================================================"
        echo "Artifacts ready for dashboard build"
        ls -la calculations/


  # ====================================================================
  # STAGE 2: BUILD DASHBOARD
  # ====================================================================

  build-dashboard:
    name: "Stage 2: Build Dashboard"
    needs: collect-data
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download calculation artifacts
      uses: actions/download-artifact@v3
      with:
        name: dora-calculations

    - name: "ðŸ—ï¸ Verify Dashboard Files"
      run: |
        echo "======================================================================"
        echo "DORA PRESENTATION LAYER - Dashboard Verification"
        echo "======================================================================"

        if [ ! -f "public/index.html" ]; then
          echo "âŒ Dashboard not found"
          exit 1
        fi

        if [ ! -f "public/report.js" ]; then
          echo "âŒ Report script not found"
          exit 1
        fi

        if [ ! -f "public/report.css" ]; then
          echo "âŒ Report styles not found"
          exit 1
        fi

        if [ ! -f "calculations/MANIFEST.json" ]; then
          echo "âŒ Manifest not found"
          exit 1
        fi

        echo "âœ“ Dashboard files verified"
        echo "âœ“ index.html exists"
        echo "âœ“ report.js exists"
        echo "âœ“ report.css exists"
        echo "âœ“ MANIFEST.json exists"

    - name: "ðŸ“Š Verify Dashboard Data"
      run: |
        python3 << 'EOF'
import json
from pathlib import Path

manifest = json.load(open('calculations/MANIFEST.json'))

print("\n" + "="*70)
print("DASHBOARD DATA VERIFICATION")
print("="*70)

print(f"\nâœ“ Validation Status: {manifest['validation_status']}")
print(f"âœ“ Validation Errors: {manifest['summary']['validation_errors']}")

print(f"\nKey Metrics:")
print(f"  â€¢ Total Commits: {manifest['global_metrics']['commits.json']['total_commits']}")
print(f"  â€¢ Repositories: {manifest['global_metrics']['summary.json']['repos_analyzed']}")

if 'testing_metrics' in manifest:
    tm = manifest['testing_metrics']['global']
    print(f"  â€¢ Test Files: {tm['total_test_files']}")
    print(f"  â€¢ Epics: {tm['total_epics_found']}")
    print(f"  â€¢ User Stories: {tm['total_user_stories_found']}")

print(f"\nRepositories:")
for repo in manifest['per_repo_metrics']:
    print(f"  â€¢ {repo}")

print("\n" + "="*70)
print("âœ“ DASHBOARD DATA VERIFIED")
print("="*70 + "\n")
EOF

    - name: "âœ“ Stage 2 Complete"
      run: |
        echo "======================================================================"
        echo "âœ“ DASHBOARD BUILD STAGE COMPLETE"
        echo "======================================================================"
        echo "Dashboard ready for deployment"


  # ====================================================================
  # STAGE 3: DEPLOY TO GITHUB PAGES
  # ====================================================================

  deploy-github-pages:
    name: "Stage 3: Deploy to GitHub Pages"
    needs: [collect-data, build-dashboard]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download calculation artifacts
      uses: actions/download-artifact@v3
      with:
        name: dora-calculations

    - name: "ðŸ“¦ Prepare deployment package"
      run: |
        echo "======================================================================"
        echo "DORA DEPLOYMENT LAYER - Preparing GitHub Pages"
        echo "======================================================================"

        # Create deployment directory
        mkdir -p _site

        # Copy public dashboard
        cp -r public/* _site/

        # Copy calculations for inspection
        cp -r calculations _site/
        cp -r git_artifacts _site/
        cp -r ci_artifacts _site/

        # Copy documentation
        cp REPORT_ACCESS.md _site/
        cp docs/index.md _site/README.md

        echo "âœ“ Deployment package prepared"
        ls -la _site/

    - name: "ðŸš€ Deploy to GitHub Pages"
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_site
        force_orphan: false
        cname: dora-metrics.vionascu.dev

    - name: "âœ… Deployment Summary"
      run: |
        echo ""
        echo "======================================================================"
        echo "âœ“ DEPLOYMENT STAGE COMPLETE"
        echo "======================================================================"
        echo ""
        echo "Dashboard deployed to GitHub Pages!"
        echo ""
        echo "ðŸ“Š Access Points:"
        echo "  â€¢ Main: ${{ steps.deployment.outputs.page_url }}public/index.html"
        echo "  â€¢ Calculations: ${{ steps.deployment.outputs.page_url }}calculations/MANIFEST.json"
        echo "  â€¢ Documentation: ${{ steps.deployment.outputs.page_url }}README.md"
        echo ""
        echo "======================================================================"


  # ====================================================================
  # FINAL STATUS
  # ====================================================================

  workflow-summary:
    name: "Workflow Summary"
    needs: [collect-data, build-dashboard, deploy-github-pages]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: "ðŸ“‹ Generate Workflow Report"
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           DORA METRICS PIPELINE - WORKFLOW COMPLETE               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "STAGE 1: DATA COLLECTION"
        echo "  Status: ${{ needs.collect-data.result }}"
        echo "  Tasks:"
        echo "    âœ“ Parse repository configuration"
        echo "    âœ“ Collect git artifacts"
        echo "    âœ“ Collect CI artifacts"
        echo "    âœ“ Scan GitHub for epics & tests"
        echo "    âœ“ Calculate metrics"
        echo "    âœ“ Calculate test metrics"
        echo "    âœ“ Validate data quality"
        echo "    âœ“ Generate validation manifest"
        echo ""
        echo "STAGE 2: BUILD DASHBOARD"
        echo "  Status: ${{ needs.build-dashboard.result }}"
        echo "  Tasks:"
        echo "    âœ“ Verify dashboard files"
        echo "    âœ“ Verify dashboard data"
        echo ""
        echo "STAGE 3: DEPLOY TO GITHUB PAGES"
        echo "  Status: ${{ needs.deploy-github-pages.result }}"
        echo "  Tasks:"
        echo "    âœ“ Prepare deployment package"
        echo "    âœ“ Deploy to GitHub Pages"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        if [ "${{ needs.collect-data.result }}" = "success" ] && [ "${{ needs.build-dashboard.result }}" = "success" ] && [ "${{ needs.deploy-github-pages.result }}" = "success" ]; then
          echo "âœ… ALL STAGES COMPLETED SUCCESSFULLY"
        else
          echo "âš ï¸  SOME STAGES FAILED - CHECK LOGS"
        fi
        echo ""
