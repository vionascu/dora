name: DORA Metrics Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:

  # STAGE 1: DATA COLLECTION
  collect-data:
    name: "Stage 1: Collect Data & Calculate Metrics"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Create required directories
      run: |
        mkdir -p git_artifacts
        mkdir -p ci_artifacts
        mkdir -p calculations/per_repo
        mkdir -p calculations/global

    - name: "ğŸ“Š Parse Repository Configuration"
      run: |
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - Parsing ReposInput.md"
        echo "======================================================================"
        python3 src/collection/collect_git.py --print-repos

    - name: "ğŸ“¥ Collect Git Artifacts"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - Git Data Extraction"
        echo "======================================================================"
        python3 src/collection/collect_git.py

    - name: "ğŸ”§ Collect CI Artifacts"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - CI Artifacts Extraction"
        echo "======================================================================"
        python3 src/collection/collect_ci.py

    - name: "ğŸ” Scan GitHub for Epics & Tests"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA COLLECTION LAYER - GitHub Artifact Scanning"
        echo "======================================================================"
        python3 src/collection/scan_github_artifacts.py

    - name: "ğŸ§® Calculate Metrics"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA CALCULATION LAYER - Metrics Computation"
        echo "======================================================================"
        python3 src/calculations/calculate.py

    - name: "ğŸ“ˆ Calculate Test Metrics"
      run: python3 src/calculations/calculate_test_metrics.py

    - name: "âœ… Validate Data Quality"
      run: |
        echo ""
        echo "======================================================================"
        echo "DORA VALIDATION LAYER - Quality Gates"
        echo "======================================================================"
        python3 src/validation/validate.py

    - name: "ğŸ“‹ Generate Validation Manifest"
      run: python3 src/calculations/calculate_test_metrics.py

    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dora-calculations
        path: |
          calculations/
          git_artifacts/
          ci_artifacts/
        retention-days: 30

    - name: "âœ“ Stage 1 Complete"
      run: |
        echo "======================================================================"
        echo "âœ“ DATA COLLECTION STAGE COMPLETE"
        echo "======================================================================"
        ls -la calculations/


  # STAGE 2: BUILD DASHBOARD
  build-dashboard:
    name: "Stage 2: Build Dashboard"
    needs: collect-data
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download calculation artifacts
      uses: actions/download-artifact@v4
      with:
        name: dora-calculations

    - name: "ğŸ—ï¸ Verify Dashboard Files"
      run: |
        echo "======================================================================"
        echo "DORA PRESENTATION LAYER - Dashboard Verification"
        echo "======================================================================"

        if [ ! -f "public/index.html" ]; then
          echo "âŒ Dashboard not found"
          exit 1
        fi

        if [ ! -f "public/report.js" ]; then
          echo "âŒ Report script not found"
          exit 1
        fi

        if [ ! -f "public/report.css" ]; then
          echo "âŒ Report styles not found"
          exit 1
        fi

        if [ ! -f "calculations/MANIFEST.json" ]; then
          echo "âŒ Manifest not found"
          exit 1
        fi

        echo "âœ“ Dashboard files verified"
        echo "âœ“ index.html exists"
        echo "âœ“ report.js exists"
        echo "âœ“ report.css exists"
        echo "âœ“ MANIFEST.json exists"

    - name: "ğŸ“Š Verify Dashboard Data"
      run: |
        echo ""
        echo "======================================================================"
        echo "DASHBOARD DATA VERIFICATION"
        echo "======================================================================"

        if [ ! -f "calculations/MANIFEST.json" ]; then
          echo "âŒ Manifest file not found"
          exit 1
        fi

        echo "âœ“ Manifest file exists"
        echo "âœ“ Dashboard ready for deployment"

    - name: "âœ“ Stage 2 Complete"
      run: |
        echo "======================================================================"
        echo "âœ“ DASHBOARD BUILD STAGE COMPLETE"
        echo "======================================================================"
        echo "Dashboard ready for deployment"


  # STAGE 3: DEPLOY TO GITHUB PAGES
  deploy-github-pages:
    name: "Stage 3: Deploy to GitHub Pages"
    needs: [collect-data, build-dashboard]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download calculation artifacts
      uses: actions/download-artifact@v4
      with:
        name: dora-calculations

    - name: "ğŸ“¦ Prepare deployment package"
      run: |
        echo "======================================================================"
        echo "DORA DEPLOYMENT LAYER - Preparing GitHub Pages"
        echo "======================================================================"

        mkdir -p _site

        cp -r public/* _site/
        cp -r calculations _site/
        cp -r git_artifacts _site/
        cp -r ci_artifacts _site/

        cp REPORT_ACCESS.md _site/
        cp docs/index.md _site/README.md

        echo "âœ“ Deployment package prepared"
        ls -la _site/

    - name: "ğŸš€ Deploy to GitHub Pages"
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./_site
        force_orphan: false

    - name: "âœ… Deployment Summary"
      run: |
        echo ""
        echo "======================================================================"
        echo "âœ“ DEPLOYMENT STAGE COMPLETE"
        echo "======================================================================"
        echo ""
        echo "Dashboard deployed to GitHub Pages!"
        echo ""
        echo "ğŸ“Š Access Points:"
        echo "  â€¢ Main: https://vionascu.github.io/dora/public/index.html"
        echo "  â€¢ Calculations: https://vionascu.github.io/dora/calculations/MANIFEST.json"
        echo "  â€¢ Documentation: https://vionascu.github.io/dora/README.md"
        echo ""
        echo "======================================================================"


  # FINAL STATUS
  workflow-summary:
    name: "Workflow Summary"
    needs: [collect-data, build-dashboard, deploy-github-pages]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Generate Workflow Report
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘           DORA METRICS PIPELINE - WORKFLOW COMPLETE               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "STAGE 1: DATA COLLECTION"
        echo "  Status: ${{ needs.collect-data.result }}"
        echo ""
        echo "STAGE 2: BUILD DASHBOARD"
        echo "  Status: ${{ needs.build-dashboard.result }}"
        echo ""
        echo "STAGE 3: DEPLOY TO GITHUB PAGES"
        echo "  Status: ${{ needs.deploy-github-pages.result }}"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        if [ "${{ needs.collect-data.result }}" = "success" ] && [ "${{ needs.build-dashboard.result }}" = "success" ] && [ "${{ needs.deploy-github-pages.result }}" = "success" ]; then
          echo "âœ… ALL STAGES COMPLETED SUCCESSFULLY"
        else
          echo "âš ï¸  CHECK LOGS FOR DETAILS"
        fi
        echo ""
