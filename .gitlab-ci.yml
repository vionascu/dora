# DORA Metrics Pipeline for GitLab CI/CD
# Collects metrics and deploys dashboard to GitLab Pages

stages:
  - collect
  - calculate
  - deploy

variables:
  PYTHONPATH: "$CI_PROJECT_DIR"

# Stage 1: Collect Git Data
collect_git:
  stage: collect
  image: python:3.9
  variables:
    GIT_DEPTH: 0
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "======================================================================"
    - echo "DORA COLLECTION LAYER - Git Data Extraction"
    - echo "======================================================================"
    - python3 src/collection/collect_git.py
  artifacts:
    paths:
      - git_artifacts/
    expire_in: 1 day
  only:
    - main
    - master
    - schedules
  retry:
    max: 2
    when:
      - script_failure

# Stage 2: Calculate Metrics
calculate_metrics:
  stage: calculate
  image: python:3.9
  dependencies:
    - collect_git
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "======================================================================"
    - echo "DORA CALCULATION LAYER - Metrics Computation"
    - echo "======================================================================"
    - python3 src/calculations/calculate.py
    - echo ""
    - echo "======================================================================"
    - echo "DORA TEST METRICS - Test Coverage Analysis"
    - echo "======================================================================"
    - python3 src/calculations/calculate_test_metrics.py
    - echo ""
    - echo "======================================================================"
    - echo "DORA EVOLUTION LAYER - Velocity & Quality Indicators"
    - echo "======================================================================"
    - python3 src/calculations/calculate_evolution_metrics.py
  artifacts:
    paths:
      - calculations/
      - git_artifacts/
    expire_in: 30 days
  only:
    - main
    - master
    - schedules
  retry:
    max: 2
    when:
      - script_failure

# Stage 3: Deploy to GitLab Pages
pages:
  stage: deploy
  image: python:3.9
  dependencies:
    - calculate_metrics
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "======================================================================"
    - echo "DORA DEPLOYMENT - Preparing GitLab Pages"
    - echo "======================================================================"
    - |
      mkdir -p public
      # Copy dashboard
      cp -r public/* public_output/ 2>/dev/null || true
      mkdir -p public_output
      cp -r public/* public_output/ 2>/dev/null || true
      cp public/index.html public_output/index.html 2>/dev/null || true
      cp public/report.js public_output/report.js 2>/dev/null || true
      cp public/report.css public_output/report.css 2>/dev/null || true
      # Copy calculations
      cp -r calculations public_output/
      # Copy documentation
      cp -r docs public_output/
    - |
      # Move to public folder for GitLab Pages
      rm -rf public
      mv public_output public
    - echo "âœ… Dashboard ready for deployment"
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: never
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.pages.gitlab.io/$CI_PROJECT_NAME
  only:
    - main
    - master
    - schedules
  retry:
    max: 2
    when:
      - script_failure

# Scheduled job: Daily metrics collection
scheduled_collection:
  stage: collect
  image: python:3.9
  variables:
    GIT_DEPTH: 0
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "======================================================================"
    - echo "DORA SCHEDULED COLLECTION - Daily Metrics Update"
    - echo "======================================================================"
    - python3 src/collection/collect_git.py
  artifacts:
    paths:
      - git_artifacts/
    expire_in: 1 day
  only:
    - schedules
  retry:
    max: 2
    when:
      - script_failure
