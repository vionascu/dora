# DORA Metrics Pipeline for GitLab CI/CD
# Collects metrics and deploys dashboard to GitLab Pages

stages:
  - collect
  - calculate
  - deploy

variables:
  PYTHONPATH: "$CI_PROJECT_DIR"

# Default configuration for all jobs
default:
  tags:
    - docker
    - linux
  retry:
    max: 2
    when:
      - script_failure
      - stuck_or_timeout_failure
      - runner_system_failure

# Stage 1: Collect Git Data
collect_git:
  stage: collect
  image: python:3.9
  variables:
    GIT_DEPTH: 0
  before_script:
    - echo "ðŸ“¦ Installing Python dependencies..."
    - pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt
    - echo "âœ… Dependencies installed"
  script:
    - echo "======================================================================"
    - echo "DORA COLLECTION LAYER - Git Data Extraction"
    - echo "======================================================================"
    - python3 src/collection/collect_git.py
  artifacts:
    paths:
      - git_artifacts/
    expire_in: 1 day
  only:
    - main
    - master
    - schedules
  allow_failure: false

# Stage 2: Calculate Metrics
calculate_metrics:
  stage: calculate
  image: python:3.9
  dependencies:
    - collect_git
  before_script:
    - echo "ðŸ“¦ Installing Python dependencies..."
    - pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt
    - echo "âœ… Dependencies installed"
  script:
    - echo "======================================================================"
    - echo "DORA CALCULATION LAYER - Metrics Computation"
    - echo "======================================================================"
    - python3 src/calculations/calculate.py
    - echo ""
    - echo "======================================================================"
    - echo "DORA TEST METRICS - Test Coverage Analysis"
    - echo "======================================================================"
    - python3 src/calculations/calculate_test_metrics.py
    - echo ""
    - echo "======================================================================"
    - echo "DORA EVOLUTION LAYER - Velocity & Quality Indicators"
    - echo "======================================================================"
    - python3 src/calculations/calculate_evolution_metrics.py
    - echo "âœ… All calculations complete"
  artifacts:
    paths:
      - calculations/
      - git_artifacts/
    expire_in: 30 days
  only:
    - main
    - master
    - schedules

# Stage 3: Deploy to GitLab Pages
pages:
  stage: deploy
  image: python:3.9
  dependencies:
    - calculate_metrics
  before_script:
    - echo "ðŸ“¦ Installing dependencies..."
    - pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt
    - echo "âœ… Dependencies installed"
  script:
    - echo "======================================================================"
    - echo "DORA DEPLOYMENT - Preparing GitLab Pages"
    - echo "======================================================================"
    - |
      mkdir -p public_output
      # Copy dashboard files
      if [ -d "public" ]; then
        echo "ðŸ“‹ Copying dashboard files..."
        cp -v public/*.html public_output/ 2>/dev/null || true
        cp -v public/*.js public_output/ 2>/dev/null || true
        cp -v public/*.css public_output/ 2>/dev/null || true
      fi
      # Copy calculations
      if [ -d "calculations" ]; then
        echo "ðŸ“Š Copying calculations..."
        cp -r calculations public_output/
      fi
      # Copy documentation
      if [ -d "docs" ]; then
        echo "ðŸ“š Copying documentation..."
        cp -r docs public_output/
      fi
    - |
      # Move to public folder for GitLab Pages
      echo "ðŸš€ Finalizing deployment..."
      rm -rf public
      mv public_output public
    - echo "âœ… Dashboard ready for deployment"
    - ls -la public/
  artifacts:
    paths:
      - public
    expire_in: never
  environment:
    name: production
    url: https://$CI_PROJECT_NAMESPACE.pages.gitlab.io/$CI_PROJECT_NAME
  only:
    - main
    - master
    - schedules

# Scheduled job: Daily metrics collection
scheduled_collection:
  stage: collect
  image: python:3.9
  variables:
    GIT_DEPTH: 0
  before_script:
    - echo "ðŸ“¦ Installing Python dependencies..."
    - pip install --upgrade pip setuptools wheel
    - pip install -r requirements.txt
    - echo "âœ… Dependencies installed"
  script:
    - echo "======================================================================"
    - echo "DORA SCHEDULED COLLECTION - Daily Metrics Update"
    - echo "======================================================================"
    - python3 src/collection/collect_git.py
    - echo "âœ… Scheduled collection complete"
  artifacts:
    paths:
      - git_artifacts/
    expire_in: 1 day
  only:
    - schedules
